generator client {
  provider = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int       @id @default(autoincrement())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  name           String?
  email          String    @unique
  hashedPassword String?
  role           String    @default("USER")
  sessions       Session[]
  tokens         Token[]
}

model Session {
  id                 Int       @id @default(autoincrement())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?
  userId             Int?
  user               User?     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Token {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hashedToken String
  type        String
  expiresAt   DateTime
  sentTo      String
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hashedToken, type])
  @@index([userId])
}

model Commit {
  id                  Int                 @id @default(autoincrement())
  ref                 String              @unique
  createdDate         DateTime            @default(now())
  updatedDate         DateTime            @updatedAt
  conditionals        Int                 @default(0)
  coveredConditionals Int                 @default(0)
  coveredElements     Int                 @default(0)
  coveredMethods      Int                 @default(0)
  coveredPercentage   Float               @default(0)
  coveredStatements   Int                 @default(0)
  elements            Int                 @default(0)
  methods             Int                 @default(0)
  statements          Int                 @default(0)
  hits                Int                 @default(0)
  blockerSonarIssues  Int                 @default(0)
  criticalSonarIssues Int                 @default(0)
  infoSonarIssues     Int                 @default(0)
  majorSonarIssues    Int                 @default(0)
  minorSonarIssues    Int                 @default(0)
  message             String?
  codeIssues          CodeIssueOnCommit[]
  CommitOnBranch      CommitOnBranch[]
  PackageCoverage     PackageCoverage[]
  Project             Project[]
  Test                Test[]
  PullRequest         PullRequest[]
}

model Test {
  id                  Int               @id @default(autoincrement())
  commitId            Int
  testName            String
  statements          Int
  conditionals        Int
  methods             Int
  coveredStatements   Int
  coveredConditionals Int
  coveredMethods      Int
  coveredPercentage   Float             @default(0)
  createdDate         DateTime          @default(now())
  updatedDate         DateTime          @default(now()) @updatedAt
  coveredElements     Int               @default(0)
  elements            Int               @default(0)
  hits                Int               @default(0)
  repositoryRoot      String?
  commit              Commit            @relation(fields: [commitId], references: [id], onDelete: Cascade)
  PackageCoverage     PackageCoverage[]
  TestInstance        TestInstance[]

  @@unique([testName, commitId])
  @@index([commitId])
}

model TestInstance {
  id                  Int      @id @default(autoincrement())
  index               Int
  testId              Int
  statements          Int
  conditionals        Int
  methods             Int
  elements            Int      @default(0)
  hits                Int      @default(0)
  coveredElements     Int      @default(0)
  coveredStatements   Int
  coveredConditionals Int
  coveredMethods      Int
  coveredPercentage   Float    @default(0)
  createdDate         DateTime @default(now())
  updatedDate         DateTime @default(now()) @updatedAt
  dataSize            Int      @default(0)
  test                Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  coverageFileKey     String?

  @@index([testId])
}

model PackageCoverage {
  id                  Int            @id @default(autoincrement())
  name                String
  testId              Int?
  createdDate         DateTime       @default(now())
  updatedDate         DateTime       @updatedAt
  statements          Int
  conditionals        Int
  methods             Int
  coveredStatements   Int
  coveredConditionals Int
  coveredMethods      Int
  coveredPercentage   Float          @default(0)
  depth               Int            @default(0)
  coveredElements     Int            @default(0)
  elements            Int            @default(0)
  commitId            Int?
  hits                Int            @default(0)
  codeIssues          Int            @default(0)
  changeRatio         Float          @default(0)
  changes             Int            @default(0)
  commit              Commit?        @relation(fields: [commitId], references: [id])
  test                Test?          @relation(fields: [testId], references: [id], onDelete: Cascade)
  FileCoverage        FileCoverage[]

  @@index([commitId])
  @@index([testId])
}

model FileCoverage {
  id                      Int                       @id @default(autoincrement())
  name                    String
  packageCoverageId       Int?
  createdDate             DateTime                  @default(now())
  statements              Int
  conditionals            Int
  methods                 Int
  coveredStatements       Int
  coveredConditionals     Int
  coveredMethods          Int
  coveredPercentage       Float                     @default(0)
  updatedDate             DateTime                  @updatedAt
  coveredElements         Int                       @default(0)
  elements                Int                       @default(0)
  hits                    Int                       @default(0)
  codeIssues              Int                       @default(0)
  changeRatio             Float                     @default(0)
  changes                 Int                       @default(0)
  coverageData            Bytes
  packageCoverage         PackageCoverage?          @relation(fields: [packageCoverageId], references: [id], onDelete: Cascade)
  CodeIssueOnFileCoverage CodeIssueOnFileCoverage[]

  @@index([packageCoverageId])
}

model Group {
  id          Int       @id @default(autoincrement())
  name        String
  createdDate DateTime  @default(now())
  updatedDate DateTime  @updatedAt
  slug        String    @default("")
  githubName  String    @default("")
  Project     Project[]

  @@index([slug])
}

model PrHook {
  id          Int      @id @default(autoincrement())
  payload     String   @db.Text
  createdDate DateTime @default(now())
  updatedDate DateTime @updatedAt
  Project     Project? @relation(references: [id], onDelete: Cascade, fields: [projectId])
  projectId   Int?
}

model JobLog {
  id          Int      @id @default(autoincrement())
  name        String
  message     String   @default("") @db.VarChar(1000)
  createdDate DateTime @default(now())
  updatedDate DateTime @updatedAt
  namespace   String   @default("")
  repository  String   @default("")
  timeTaken   Int      @default(0)
  status      String   @default("")
  commitRef   String   @default("")
}

model CodeIssue {
  id                      Int                       @id @default(autoincrement())
  hash                    String                    @unique
  file                    String
  line                    Int
  message                 String                    @default("")
  effort                  String                    @default("")
  type                    String
  severity                String
  tags                    String
  createdDate             DateTime                  @default(now())
  updatedDate             DateTime                  @updatedAt
  commits                 CodeIssueOnCommit[]
  CodeIssueOnFileCoverage CodeIssueOnFileCoverage[]
}

model CodeIssueOnCommit {
  commitId    Int
  codeIssueId Int
  codeIssue   CodeIssue @relation(fields: [codeIssueId], references: [id], onDelete: Cascade)
  commit      Commit    @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@id([commitId, codeIssueId])
  @@index([codeIssueId])
}

model CodeIssueOnFileCoverage {
  fileCoverageId Int
  codeIssueId    Int
  CodeIssue      CodeIssue    @relation(fields: [codeIssueId], references: [id], onDelete: Cascade)
  FileCoverage   FileCoverage @relation(fields: [fileCoverageId], references: [id], onDelete: Cascade)

  @@id([fileCoverageId, codeIssueId])
  @@index([codeIssueId])
}

model Project {
  id                      Int              @id @default(autoincrement())
  name                    String
  defaultBaseBranch       String
  createdDate             DateTime         @default(now())
  updatedDate             DateTime         @updatedAt
  slug                    String           @default("")
  groupId                 Int
  lastCommitId            Int?
  requireCoverageIncrease Boolean          @default(false)
  group                   Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  lastCommit              Commit?          @relation(fields: [lastCommitId], references: [id])
  Branch                  Branch[]
  ExpectedResult          ExpectedResult[]

  PrHook      PrHook[]
  PullRequest PullRequest[]
  @@index([groupId])
  @@index([lastCommitId])
  @@index([slug])
}

model ExpectedResult {
  id              Int      @id @default(autoincrement())
  testName        String
  branchPattern   String
  requireIncrease Boolean
  projectId       Int
  count           Int
  createdDate     DateTime @default(now())
  updatedDate     DateTime @updatedAt
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model PullRequest {
  id          Int      @id @default(autoincrement())
  description String   @default("")
  sourceId    Int      @unique @default(0)
  name        String
  baseBranch  String
  branch      String
  commit      Commit   @relation(references: [id], onDelete: Cascade, fields: [commitId])
  createdDate DateTime @default(now())
  updatedDate DateTime @updatedAt
  state       String   @default("open")
  url         String   @default("")

  projectId Int
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  commitId  Int
}

model Branch {
  id             Int              @id @default(autoincrement())
  name           String
  projectId      Int
  baseBranch     String
  createdDate    DateTime         @default(now())
  updatedDate    DateTime         @updatedAt
  slug           String           @default("")
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  CommitOnBranch CommitOnBranch[]

  @@unique([name, projectId])
  @@index([projectId])
}

model CommitOnBranch {
  commitId Int
  branchId Int
  Branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  Commit   Commit @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@id([commitId, branchId])
  @@index([branchId])
}

model Setting {
  id    Int    @id @default(autoincrement())
  name  String @unique
  value String @default("")
}
